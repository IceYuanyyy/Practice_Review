CREATE TABLE `practice_record` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `question_id` bigint NOT NULL COMMENT '题目ID',
  `user_answer` text COLLATE utf8mb4_unicode_ci COMMENT '用户答案',
  `is_correct` tinyint(1) NOT NULL COMMENT '是否正确',
  `cost_time` int DEFAULT NULL COMMENT '答题耗时（秒）',
  `practice_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '练习时间',
  PRIMARY KEY (`id`),
  KEY `idx_question` (`question_id`),
  KEY `idx_correct` (`is_correct`),
  KEY `idx_time` (`practice_time`)
) ENGINE=InnoDB AUTO_INCREMENT=15 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='练习记录表';

CREATE TABLE `question` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `type` varchar(20) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '题型：choice(选择题)/judge(判断题)',
  `display_order` int DEFAULT '0' COMMENT '显示顺序（按类型分组，从1开始）',
  `subject` varchar(50) COLLATE utf8mb4_unicode_ci DEFAULT '未分类' COMMENT '科目',
  `content` text COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '题目内容',
  `options` json DEFAULT NULL COMMENT '选项（选择题用，格式：["A:选项1","B:选项2","C:选项3","D:选项4"]）',
  `answer` varchar(200) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '答案',
  `analysis` text COLLATE utf8mb4_unicode_ci COMMENT '答案解析',
  `difficulty` varchar(10) COLLATE utf8mb4_unicode_ci DEFAULT 'medium' COMMENT '难度：easy/medium/hard',
  `is_marked` tinyint(1) DEFAULT '0' COMMENT '是否标记为重点',
  `wrong_count` int DEFAULT '0' COMMENT '做错次数',
  `practice_count` int DEFAULT '0' COMMENT '练习次数',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_type` (`type`),
  KEY `idx_subject` (`subject`),
  KEY `idx_difficulty` (`difficulty`),
  KEY `idx_type_display_order` (`type`,`display_order`)
) ENGINE=InnoDB AUTO_INCREMENT=549 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='题目表';

CREATE DEFINER=`root`@`localhost` TRIGGER `before_question_insert` BEFORE INSERT ON `question` FOR EACH ROW BEGIN
    DECLARE max_order INT;
    -- 获取该类型且该科目的最大序号
    SELECT IFNULL(MAX(display_order), 0) INTO max_order 
    FROM question 
    WHERE type = NEW.type AND subject = NEW.subject;
    -- 设置新题目的序号
    SET NEW.display_order = max_order + 1;
END;


CREATE TABLE `subject` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `name` varchar(50) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT '科目名称',
  `question_count` int DEFAULT '0' COMMENT '题目数量',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `name` (`name`),
  KEY `idx_name` (`name`)
) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='科目表';

-- ==========================================
-- 2. 重置现有数据：重新编号所有题目 (Migration Logic)
-- ==========================================
SET @row_num = 0;
-- 显式指定排序规则，防止 Illegal mix of collations 错误
SET @prev_subject = '' COLLATE utf8mb4_unicode_ci;
SET @prev_type = '' COLLATE utf8mb4_unicode_ci;

UPDATE question
SET display_order = IF(@prev_subject != subject OR @prev_type != type,
    @row_num := 1,
    @row_num := @row_num + 1),
    subject = @prev_subject := subject,
    type = @prev_type := type
ORDER BY subject, type, display_order;